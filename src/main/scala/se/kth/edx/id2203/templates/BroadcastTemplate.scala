//{"gradingToken":[45,45,45,45,45,66,69,71,73,78,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10,86,101,114,115,105,111,110,58,32,66,67,80,71,32,118,49,46,53,53,10,10,104,81,73,77,65,57,79,116,77,118,84,69,98,74,49,102,65,81,47,43,76,71,120,71,104,119,112,73,111,109,100,72,86,117,65,117,89,121,52,47,109,65,74,121,55,74,78,86,111,76,76,76,89,115,112,53,71,113,88,107,114,114,122,116,10,69,116,75,57,108,68,113,103,98,105,80,85,120,102,120,71,66,76,76,121,100,57,106,65,81,86,75,89,86,84,83,104,107,104,111,108,85,67,47,83,103,55,102,112,86,56,85,97,77,89,55,99,90,74,116,47,43,122,68,99,43,48,116,79,10,50,86,100,49,54,121,100,111,106,76,103,78,87,65,117,90,101,122,88,110,54,72,90,65,122,101,54,75,76,48,103,50,43,113,71,54,50,54,119,87,115,53,57,97,99,83,75,72,66,106,98,118,117,119,43,53,51,115,80,121,80,76,121,90,10,73,69,102,78,103,66,106,57,65,104,89,118,110,103,86,110,76,69,77,111,118,88,87,89,103,77,50,52,115,90,108,43,116,102,79,76,72,71,79,113,54,83,114,66,86,57,84,121,50,73,67,87,68,112,47,107,70,121,89,51,119,88,87,77,10,51,114,118,48,52,53,81,113,47,79,118,49,52,69,114,104,98,114,57,111,106,72,120,65,54,104,79,70,68,57,74,97,80,116,81,109,75,66,65,79,49,115,81,102,66,85,114,97,79,102,70,47,66,103,113,75,72,67,74,105,86,67,67,99,10,68,71,121,104,109,90,67,118,112,49,75,99,88,105,50,82,47,57,116,117,52,47,109,67,70,43,121,66,47,81,87,54,48,87,121,87,71,47,50,105,101,78,117,75,48,50,51,120,66,108,66,115,76,120,101,115,79,74,71,103,117,112,120,56,10,107,57,122,118,47,97,101,90,108,77,104,73,101,71,111,112,121,122,82,86,119,97,69,98,109,79,98,51,79,48,68,119,87,97,73,48,83,121,75,100,85,90,78,55,80,110,49,65,75,72,49,98,105,47,111,82,88,85,81,104,107,75,109,82,10,51,120,43,88,78,111,107,98,110,80,98,108,103,57,48,87,99,48,113,120,101,75,69,68,85,69,67,50,67,105,100,111,55,101,118,104,104,54,73,53,75,100,73,51,51,98,82,57,70,72,122,114,122,69,75,73,101,119,98,109,75,67,113,70,10,65,65,119,103,118,47,83,67,85,87,89,56,48,72,43,116,65,55,57,82,113,116,102,87,48,111,53,72,118,50,87,109,80,82,107,118,67,102,119,78,83,111,79,102,65,119,109,97,105,74,70,80,80,117,55,107,66,66,89,99,53,53,106,85,10,100,75,116,97,88,50,48,56,109,65,86,101,47,49,116,111,122,81,73,78,111,101,88,52,117,106,90,111,100,122,81,74,113,106,72,73,67,48,100,115,104,122,89,87,105,107,101,76,47,43,116,74,85,69,89,120,87,118,83,87,121,89,97,72,10,47,100,116,116,120,65,115,69,71,84,54,71,122,111,79,73,112,54,121,86,79,80,69,73,75,75,50,75,78,53,99,69,119,122,79,86,110,114,79,78,87,72,73,119,116,75,99,97,82,69,106,76,120,97,82,100,78,107,121,76,121,113,114,83,10,119,67,111,66,115,84,120,99,54,54,86,102,121,72,70,66,100,79,70,115,118,120,86,83,77,113,50,108,47,50,113,79,103,73,69,116,109,106,49,122,116,115,114,68,77,66,53,97,110,87,78,79,70,109,69,84,106,119,88,48,80,90,56,121,10,110,120,100,111,89,111,74,90,111,55,81,79,87,75,85,54,49,86,81,77,66,84,112,56,71,74,53,57,102,99,121,82,49,48,81,66,78,78,47,88,65,86,67,75,77,75,43,54,104,47,48,79,118,50,78,50,88,79,67,84,71,47,53,115,10,85,103,114,107,97,65,56,68,117,69,70,78,75,47,115,97,65,80,108,66,76,74,43,57,109,83,66,51,48,66,82,77,49,119,66,65,106,66,71,86,104,88,121,90,98,86,113,66,79,79,84,115,115,120,84,118,84,110,57,113,66,109,88,79,10,120,118,65,50,77,105,80,78,50,57,114,112,110,115,90,100,75,69,84,55,90,57,56,80,49,116,77,114,90,108,105,74,90,55,90,112,57,88,84,115,81,86,52,101,67,115,80,79,110,73,115,76,118,105,66,99,99,84,50,66,121,43,103,106,10,83,51,50,73,73,70,81,52,112,55,120,100,115,83,79,66,53,113,55,81,49,122,71,108,89,68,65,90,83,119,53,78,108,69,53,89,110,87,122,110,118,85,120,65,69,90,65,121,97,104,54,107,65,90,118,120,121,75,89,61,10,61,65,56,111,117,10,45,45,45,45,45,69,78,68,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10]}

/// ### From Best Effort to Causal Order Reliable Broadcast

/// This is the first programming assignment where you will have to build and reuse multiple components.  
/// Starting bottom-up, you will first have to implement _best effort broadcast_, then _reliable broadcast_ and finally _causal order reliable broadcast_.  
/// Mind that passing each component check will give you a **partial** grade and therefore you will need to pass **all** checks to get the full grade for this programming assignment.

/// **Things to Remember**:  
/// 1. Some components such as `PerfectLink`, `Network` and `Timer` are already provided. No need to implement them.  
/// 2. Execute the imports defined below **before** compiling your component implementations.  
/// 3. We recommend making use of the component state and internal messages we have provided, if any, to complete the implementation logic.  
/// 4. You can always print messages to the output log, from within handlers to see what happens during the simulation. e.g. `println(s"Process $self delivers message $msg");`  
/// 5. Remember that during the simulation check you can print and observe the simulation time, i.e. with `System.currentTimeMillis()`.  
/// 5. Do not forget to run the checker code block after each component implementation to ensure that all properties are satisfied before exporting and submitting the notebook.  

/// Good luck! :)

package se.kth.edx.id2203.templates

import se.kth.edx.id2203.core.ExercisePrimitives._
import se.kth.edx.id2203.core.Ports._
import se.kth.edx.id2203.templates.WaitingCRB._
import se.kth.edx.id2203.validation._
import se.sics.kompics.network._
import se.sics.kompics.sl.{ Init, _ }
import se.sics.kompics.{ ComponentDefinition => _, Port => _, _ }

import scala.collection.immutable.Set
import scala.collection.mutable
import scala.collection.mutable._

/// ### Part I: Best-Effort Broadcast

//{"gradingToken":[45,45,45,45,45,66,69,71,73,78,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10,86,101,114,115,105,111,110,58,32,66,67,80,71,32,118,49,46,53,53,10,10,104,81,73,77,65,57,79,116,77,118,84,69,98,74,49,102,65,82,65,65,107,72,102,72,111,66,53,48,90,114,89,69,106,81,56,71,52,43,121,67,117,85,117,114,72,47,120,90,50,48,57,56,116,54,121,112,65,67,119,108,110,49,113,106,10,112,55,99,49,48,90,81,52,50,121,98,52,65,70,55,57,52,110,81,107,67,109,49,53,51,119,57,70,75,75,47,99,65,111,118,97,72,57,102,84,70,111,52,75,105,86,82,98,68,109,99,81,99,77,65,107,115,120,103,81,112,72,109,113,10,111,56,51,118,84,72,90,72,73,117,57,116,52,73,79,65,89,83,120,80,65,104,107,119,109,83,112,51,65,119,115,100,47,119,101,79,97,109,49,103,72,121,120,104,57,70,99,75,122,69,118,52,83,74,65,110,114,43,48,107,47,114,57,55,10,109,85,68,77,65,100,99,72,55,122,80,49,110,106,52,87,57,99,121,98,109,83,56,112,85,65,122,114,90,51,69,72,85,116,90,85,67,104,101,97,82,72,108,77,120,105,88,85,107,69,47,106,120,118,49,47,121,51,74,90,121,69,121,122,10,97,71,80,90,57,84,116,68,57,79,81,66,52,106,55,80,53,69,65,101,51,66,83,100,74,122,80,81,48,81,76,53,102,83,113,71,77,89,103,54,72,111,43,99,50,87,78,100,85,116,75,82,70,109,101,84,55,52,49,121,98,70,119,89,10,75,119,119,86,65,88,67,101,79,77,115,73,78,86,54,106,78,74,67,100,111,53,105,120,122,74,52,47,115,67,87,76,55,77,90,113,90,115,105,83,68,98,72,66,72,110,116,120,50,90,105,109,57,86,110,54,100,65,99,56,88,74,65,85,10,83,73,106,69,80,50,113,73,48,68,84,82,115,106,56,70,52,110,117,83,50,81,101,65,82,114,111,48,72,84,99,83,77,118,81,73,105,121,105,120,82,70,112,72,90,82,97,106,73,76,103,90,107,83,78,76,55,97,83,43,101,99,72,90,10,68,86,84,118,67,121,68,49,84,70,98,81,52,118,120,116,100,113,56,99,77,75,88,57,52,115,49,56,43,114,118,100,98,120,118,115,112,81,76,83,51,122,69,116,76,75,55,51,89,122,85,113,106,83,113,50,99,99,106,98,99,67,109,57,10,117,101,105,80,69,83,57,113,99,56,69,105,90,50,51,67,101,82,112,114,72,81,111,100,65,65,69,85,114,112,107,106,82,118,119,110,89,78,103,82,80,86,76,69,50,50,51,81,69,76,52,106,121,72,113,122,117,73,76,66,121,49,105,49,10,108,84,99,117,98,116,73,77,117,52,74,43,66,121,116,80,101,56,107,86,116,112,69,51,90,86,99,104,75,54,53,101,114,80,68,51,76,98,107,51,80,78,88,82,88,115,99,122,66,85,54,71,80,56,72,97,75,52,109,69,117,120,67,113,10,105,85,90,71,116,116,82,85,43,116,54,85,55,82,115,65,81,54,47,113,74,86,73,54,65,65,107,113,49,57,78,85,87,78,65,108,69,50,102,57,55,99,114,110,88,52,69,89,109,86,78,84,90,122,89,54,70,53,105,81,43,76,55,83,10,119,65,48,66,97,78,67,100,101,108,114,122,70,81,111,86,88,68,99,47,108,120,108,83,102,103,86,70,67,107,110,101,111,72,54,83,114,50,120,55,99,105,105,100,118,107,48,52,90,89,78,77,107,56,105,47,98,56,121,109,105,81,113,52,10,75,115,112,43,102,70,66,75,114,49,81,89,77,121,79,80,79,122,74,75,106,68,106,110,57,76,121,117,111,102,73,47,108,119,80,70,74,88,77,52,43,43,106,90,74,43,97,112,103,90,117,101,79,53,68,86,98,103,68,66,77,50,57,119,10,57,104,101,116,69,86,82,43,107,73,109,117,86,107,84,84,120,72,84,106,69,51,84,53,67,102,56,103,106,55,80,85,112,105,47,83,47,104,110,74,119,99,56,113,67,83,101,77,104,109,112,114,54,122,121,99,73,101,87,99,84,116,89,88,10,109,88,117,55,57,119,109,116,74,85,70,71,77,66,69,86,79,54,70,51,102,50,66,101,86,74,78,74,98,79,120,65,98,83,99,68,51,68,117,99,76,52,115,122,114,51,74,69,108,85,87,73,49,52,43,50,78,80,100,65,103,71,54,112,10,80,108,122,89,119,65,114,70,78,56,97,67,97,99,121,55,71,85,72,79,10,61,112,119,47,119,10,45,45,45,45,45,69,78,68,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10]}

/// A Best-Effort Broadcast Abstraction (BEB), in Kompics terms, is a component that **provides** the following port _(already imported in the notebook)_.

/// ```
/// class BestEffortBroadcast extends Port {
/// indication[BEB_Deliver];
/// request[BEB_Broadcast];
/// }
/// ```
/// 
/// A **BEB** component should request `BEB_Broadcast` and indicate `BEB_Deliver` events as defined below:
///
/// ```
/// case class BEB_Deliver(source: Address, payload: KompicsEvent) extends KompicsEvent;
/// case class BEB_Broadcast(payload: KompicsEvent) extends KompicsEvent;
/// ```
///
/// As you have already learnt from the course lectures, Best-Effort Broadcast should satisfy the following properties:
///
/// 1.  **Validity**: _If a correct process broadcasts a message m, then every correct process eventually delivers m._
/// 2.  **No duplication**: _No message is delivered more than once._
/// 3.  **No creation**: _If a process delivers a message m with sender s, then m was previously broadcast by process s._
/// 
/// HINT: The recommended algorithm to use in this assignment is _Basic Broadcast_ and is described in the following [document](https://d37djvu3ytnwxt.cloudfront.net/assets/courseware/v1/a91e7d1ac75367325c1efd101a9e2138/asset-v1:KTHx+ID2203.1x+2016T3+type@asset+block/basicbroadcast.pdf) in the respective lecture.
class BasicBroadcast(init: Init[BasicBroadcast]) extends ComponentDefinition {

  //BasicBroadcast Subscriptions
  val pLink = requires[PerfectLink];
  val beb = provides[BestEffortBroadcast];

  //BasicBroadcast Component State and Initialization
  val (self, topology) = init match {
    case Init(s: Address, t: Set[Address] @unchecked) => (s, t)
  };

  //BasicBroadcast Event Handlers
  beb uponEvent {
    case x: BEB_Broadcast => {
        /* WRITE YOUR CODE HERE */
        for (p <- topology) {
          trigger(PL_Send(p, x) -> pLink);
        }
    }
  }

  pLink uponEvent {
    case PL_Deliver(src, BEB_Broadcast(payload)) => {
        /* WRITE YOUR CODE HERE */
        trigger(BEB_Deliver(src, payload) -> beb);
    }
  }
}

/// ### Part II: Reliable Broadcast
//{"gradingToken":[45,45,45,45,45,66,69,71,73,78,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10,86,101,114,115,105,111,110,58,32,66,67,80,71,32,118,49,46,53,53,10,10,104,81,73,77,65,57,79,116,77,118,84,69,98,74,49,102,65,81,47,43,76,71,120,71,104,119,112,73,111,109,100,72,86,117,65,117,89,121,52,47,109,65,74,121,55,74,78,86,111,76,76,76,89,115,112,53,71,113,88,107,114,114,122,116,10,69,116,75,57,108,68,113,103,98,105,80,85,120,102,120,71,66,76,76,121,100,57,106,65,81,86,75,89,86,84,83,104,107,104,111,108,85,67,47,83,103,55,102,112,86,56,85,97,77,89,55,99,90,74,116,47,43,122,68,99,43,48,116,79,10,50,86,100,49,54,121,100,111,106,76,103,78,87,65,117,90,101,122,88,110,54,72,90,65,122,101,54,75,76,48,103,50,43,113,71,54,50,54,119,87,115,53,57,97,99,83,75,72,66,106,98,118,117,119,43,53,51,115,80,121,80,76,121,90,10,73,69,102,78,103,66,106,57,65,104,89,118,110,103,86,110,76,69,77,111,118,88,87,89,103,77,50,52,115,90,108,43,116,102,79,76,72,71,79,113,54,83,114,66,86,57,84,121,50,73,67,87,68,112,47,107,70,121,89,51,119,88,87,77,10,51,114,118,48,52,53,81,113,47,79,118,49,52,69,114,104,98,114,57,111,106,72,120,65,54,104,79,70,68,57,74,97,80,116,81,109,75,66,65,79,49,115,81,102,66,85,114,97,79,102,70,47,66,103,113,75,72,67,74,105,86,67,67,99,10,68,71,121,104,109,90,67,118,112,49,75,99,88,105,50,82,47,57,116,117,52,47,109,67,70,43,121,66,47,81,87,54,48,87,121,87,71,47,50,105,101,78,117,75,48,50,51,120,66,108,66,115,76,120,101,115,79,74,71,103,117,112,120,56,10,107,57,122,118,47,97,101,90,108,77,104,73,101,71,111,112,121,122,82,86,119,97,69,98,109,79,98,51,79,48,68,119,87,97,73,48,83,121,75,100,85,90,78,55,80,110,49,65,75,72,49,98,105,47,111,82,88,85,81,104,107,75,109,82,10,51,120,43,88,78,111,107,98,110,80,98,108,103,57,48,87,99,48,113,120,101,75,69,68,85,69,67,50,67,105,100,111,55,101,118,104,104,54,73,53,75,100,73,51,51,98,82,57,70,72,122,114,122,69,75,73,101,119,98,109,75,67,113,70,10,65,65,119,103,118,47,83,67,85,87,89,56,48,72,43,116,65,55,57,82,113,116,102,87,48,111,53,72,118,50,87,109,80,82,107,118,67,102,119,78,83,111,79,102,65,119,109,97,105,74,70,80,80,117,55,107,66,66,89,99,53,53,106,85,10,100,75,116,97,88,50,48,56,109,65,86,101,47,49,116,111,122,81,73,78,111,101,88,52,117,106,90,111,100,122,81,74,113,106,72,73,67,48,100,115,104,122,89,87,105,107,101,76,47,43,116,74,85,69,89,120,87,118,83,87,121,89,97,72,10,47,100,116,116,120,65,115,69,71,84,54,71,122,111,79,73,112,54,121,86,79,80,69,73,75,75,50,75,78,53,99,69,119,122,79,86,110,114,79,78,87,72,73,119,116,75,99,97,82,69,106,76,120,97,82,100,78,107,121,76,121,113,114,83,10,119,67,111,66,115,84,120,99,54,54,86,102,121,72,70,66,100,79,70,115,118,120,86,83,77,113,50,108,47,50,113,79,103,73,69,116,109,106,49,122,116,115,114,68,77,66,53,97,110,87,78,79,70,109,69,84,106,119,88,48,80,90,56,121,10,110,120,100,111,89,111,74,90,111,55,81,79,87,75,85,54,49,86,81,77,66,84,112,56,71,74,53,57,102,99,121,82,49,48,81,66,78,78,47,88,65,86,67,75,77,75,43,54,104,47,48,79,118,50,78,50,88,79,67,84,71,47,53,115,10,85,103,114,107,97,65,56,68,117,69,70,78,75,47,115,97,65,80,108,66,76,74,43,57,109,83,66,51,48,66,82,77,49,119,66,65,106,66,71,86,104,88,121,90,98,86,113,66,79,79,84,115,115,120,84,118,84,110,57,113,66,109,88,79,10,120,118,65,50,77,105,80,78,50,57,114,112,110,115,90,100,75,69,84,55,90,57,56,80,49,116,77,114,90,108,105,74,90,55,90,112,57,88,84,115,81,86,52,101,67,115,80,79,110,73,115,76,118,105,66,99,99,84,50,66,121,43,103,106,10,83,51,50,73,73,70,81,52,112,55,120,100,115,83,79,66,53,113,55,81,49,122,71,108,89,68,65,90,83,119,53,78,108,69,53,89,110,87,122,110,118,85,120,65,69,90,65,121,97,104,54,107,65,90,118,120,121,75,89,61,10,61,65,56,111,117,10,45,45,45,45,45,69,78,68,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10]}

/// A Reliable Broadcast Abstraction (RB), in Kompics terms, is a component that **provides** the following port _(already imported in the notebook)_.

/// ```
/// class ReliableBroadcast extends Port {
/// indication[RB_Deliver];
/// request[RB_Broadcast];
/// }
/// ```
/// 
/// An **RB** component should request `RB_Broadcast` and indicate `RB_Deliver` events, as defined below:
/// 
/// ```
/// case class RB_Deliver(source: Address, payload: KompicsEvent) extends KompicsEvent;
/// case class RB_Broadcast(payload: KompicsEvent) extends KompicsEvent;
/// ```
/// 
/// As you have already learnt from the course lectures, Reliable Broadcast adds the `Agreement` property into the already existing properties of Best-Effort Broadcast:
/// 
/// 1.  Validity: _If a correct process broadcasts a message m, then every correct process eventually delivers m._
/// 2.  No duplication: _No message is delivered more than once._
/// 3.  No creation: _If a process delivers a message m with sender s, then m was previously broadcast by process s._
/// 4.  **Agreement**: _If a message m is delivered by some correct process, then m is eventually delivered by every correct process._
/// 
/// HINT: The recommended algorithm to use in this assignment is _Eager Reliable Broadcast_ and is described in page 2 within the following [document](https://d37djvu3ytnwxt.cloudfront.net/assets/courseware/v1/6c144fd806b3568f6e2c5d7d03e27a29/asset-v1:KTHx+ID2203.1x+2016T3+type@asset+block/reliablebroadcast.pdf) in the respective lecture.
/// 
/// **Mind that, to complete this part, you will first have to implement and test Best-Effort Broadcast, defined above.**
class EagerReliableBroadcast(init: Init[EagerReliableBroadcast]) extends ComponentDefinition {
  //EagerReliableBroadcast Subscriptions
  val beb = requires[BestEffortBroadcast];
  val rb = provides[ReliableBroadcast];
  class DataMessage(val source: Address, override val payload: KompicsEvent) extends RB_Broadcast(payload);

  //EagerReliableBroadcast Component State and Initialization
  val self = init match {
    case Init(s: Address) => s
  };
  val delivered = mutable.Set[KompicsEvent]();

  //EagerReliableBroadcast Event Handlers
  rb uponEvent {
    case x @ RB_Broadcast(_) => {
        /* WRITE YOUR CODE HERE */
        trigger(BEB_Broadcast(new DataMessage(self, x.payload)) -> beb);
    }
  }

  beb uponEvent {
    case BEB_Deliver(src, y @ RB_Broadcast(payload)) => {
        /* WRITE YOUR CODE HERE */
        if(!delivered.contains(payload)){
          delivered.add(payload);
          val originalSource = y match {
              case dm: DataMessage => dm.source
              case _ => src
          }
          trigger(RB_Deliver(originalSource, payload) -> rb);
          trigger(BEB_Broadcast(y) -> beb);
        }
    }
  }
}

//Causal Reliable Broadcast
//Declare custom message types related to internal component implementation
object WaitingCRB {

  case class DataMessage(timestamp: VectorClock, payload: KompicsEvent) extends KompicsEvent;
}

/// ### Part III: Causal-Order Reliable Broadcast
//{"gradingToken":[45,45,45,45,45,66,69,71,73,78,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10,86,101,114,115,105,111,110,58,32,66,67,80,71,32,118,49,46,53,53,10,10,104,81,73,77,65,57,79,116,77,118,84,69,98,74,49,102,65,82,65,65,109,112,83,102,66,117,90,49,56,99,47,97,66,103,108,57,49,83,109,67,82,100,72,76,79,74,101,88,50,57,110,65,66,54,115,107,55,116,73,54,99,48,110,112,10,82,85,119,49,47,105,110,75,85,97,104,71,79,86,109,69,85,120,52,77,115,97,82,57,110,66,55,77,81,97,83,122,111,104,114,82,80,119,66,116,52,82,111,73,98,83,52,56,75,111,72,71,107,54,98,109,99,111,75,85,109,100,100,98,10,73,86,86,90,102,76,86,99,70,100,81,111,100,49,121,104,69,72,43,51,110,54,104,100,83,76,66,111,105,55,89,57,55,107,74,78,73,85,56,53,49,86,71,53,83,80,77,86,90,82,49,74,111,116,66,103,78,57,66,86,54,51,107,71,10,108,73,99,121,104,117,85,77,76,103,75,112,87,55,47,57,55,77,52,84,120,65,85,75,49,119,90,101,81,107,121,109,122,49,66,84,69,114,55,110,98,114,99,55,102,52,100,47,69,82,48,69,74,104,51,81,100,109,47,69,113,119,98,73,10,114,54,74,118,68,107,120,122,109,100,119,72,84,87,52,90,47,48,97,79,104,111,54,55,69,111,43,87,119,73,51,102,111,52,85,66,49,116,101,108,43,82,82,119,105,88,55,112,70,98,121,77,108,78,102,89,70,105,113,77,65,50,55,88,10,101,98,87,86,98,90,108,86,49,81,109,120,56,75,67,71,73,84,53,120,97,82,78,53,108,88,77,111,122,47,82,72,52,68,98,67,75,74,43,103,49,98,98,86,47,86,50,72,71,116,78,109,82,78,43,108,49,122,112,54,53,66,107,107,10,97,89,53,84,54,103,97,68,115,48,76,49,79,52,100,87,104,113,69,65,108,51,117,101,116,109,57,112,57,53,68,81,51,110,56,82,67,112,100,77,114,108,104,98,119,51,51,67,47,112,83,43,107,110,108,70,106,117,86,74,71,77,57,116,10,65,86,72,101,55,52,117,116,106,119,72,115,67,65,121,88,69,53,69,84,100,67,71,69,115,73,112,100,102,70,121,68,99,102,105,108,90,112,75,116,66,77,105,88,43,100,82,101,102,106,53,57,77,75,103,51,82,87,110,66,80,109,48,85,10,121,54,115,43,100,101,71,75,56,55,119,106,77,85,86,75,113,54,83,114,48,69,78,99,67,77,97,116,73,98,118,80,107,87,104,81,97,83,72,115,54,117,107,101,81,67,54,118,80,118,85,114,56,54,121,83,98,119,116,87,115,86,69,80,10,120,119,84,104,57,116,103,99,105,68,112,102,100,52,77,51,79,50,107,101,103,117,72,48,68,99,83,47,70,106,82,79,90,48,121,56,99,114,109,114,121,76,116,111,71,101,82,81,103,80,56,115,49,75,48,114,48,114,65,66,84,79,87,78,10,107,99,43,76,48,77,66,74,110,56,104,113,56,52,98,97,103,55,71,67,68,80,110,66,108,113,110,56,101,122,54,71,55,116,80,70,114,80,99,112,119,75,115,77,98,110,108,82,54,98,72,114,51,101,55,86,57,68,84,89,98,75,106,83,10,119,70,52,66,86,80,114,98,76,51,118,81,65,53,120,75,89,99,82,69,90,49,47,66,100,98,50,66,116,103,101,104,89,99,99,80,85,108,69,51,122,102,74,112,51,67,66,52,85,113,74,75,117,73,87,65,75,49,50,120,66,56,57,71,10,53,104,51,53,56,80,53,115,119,87,83,104,121,47,84,104,77,83,98,115,54,110,84,67,50,53,66,88,120,49,81,82,65,104,98,109,89,98,113,113,83,51,106,66,115,74,108,55,43,66,75,43,112,113,77,87,104,99,70,112,52,111,112,43,10,75,114,121,116,113,99,48,120,121,87,76,98,88,87,119,78,122,90,99,117,113,82,104,101,75,43,118,49,65,104,43,57,43,65,56,83,116,48,75,117,75,80,117,120,122,78,118,69,106,53,55,65,48,117,105,112,106,116,115,48,114,70,57,83,10,73,90,112,100,72,99,68,56,80,43,103,116,72,98,65,84,101,79,115,98,55,75,50,97,97,80,120,111,72,82,106,82,100,56,111,81,85,75,110,51,70,78,79,80,70,99,67,85,69,69,79,121,111,47,86,65,104,75,83,82,73,108,117,82,10,86,55,110,72,121,65,97,106,67,66,72,85,105,119,69,47,74,103,43,110,112,89,113,87,89,77,49,90,100,107,69,113,55,80,78,110,54,118,56,90,84,47,50,71,78,49,97,119,118,104,106,115,99,83,106,69,113,47,113,79,83,54,98,78,10,114,107,49,80,113,89,122,111,118,109,102,110,110,65,118,89,121,50,76,111,55,98,47,57,105,85,86,110,97,108,119,111,53,115,99,75,114,56,88,82,82,69,103,81,79,121,70,90,121,56,48,76,70,49,102,115,90,118,43,117,79,106,66,116,10,61,105,82,102,106,10,45,45,45,45,45,69,78,68,32,80,71,80,32,77,69,83,83,65,71,69,45,45,45,45,45,10]}

/// A Causal-Order Reliable Broadcast Abstraction (CRB), in Kompics terms, is a component that **provides** the following port _(already imported in the notebook)_.
/// 
/// ```
/// class CausalOrderReliableBroadcast extends Port {
///  indication[CRB_Deliver];
///  request[CRB_Broadcast];
/// }
/// ```
/// 
/// A **CRB** component should request `CRB_Broadcast` and indicate `CRB_Deliver` events, as defined below:
/// 
/// ```
/// case class CRB_Deliver(src: Address, payload: KompicsEvent) extends KompicsEvent;
/// case class CRB_Broadcast(payload: KompicsEvent) extends KompicsEvent;
/// ```
/// 
/// As you have already learnt from the course lectures, Causal-Order Reliable Broadcast adds the `Causal Delivery` property into the already existing properties of Reliable and Best-Effort Broadcast:
/// 
/// 1.  Validity: _If a correct process broadcasts a message m, then every correct process eventually delivers m._
/// 2.  No duplication: _No message is delivered more than once._
/// 3.  No creation: _If a process delivers a message m with sender s, then m was previously broadcast by process s._
/// 4.  Agreement: _If a message m is delivered by some correct process, then m is eventually delivered by every correct process._
/// 5.  **Causal delivery**: _For any message m1 that potentially caused a message m2, i.e., m1 → m2, no process delivers m2 unless it has already delivered m1._
/// 
/// HINT: The recommended algorithm to use in this assignment is _Waiting Causal Broadcast_ and is described in page 4 within the following [document](https://d37djvu3ytnwxt.cloudfront.net/assets/courseware/v1/f11d45d4cb0d9685c723dd00de427b8d/asset-v1:KTHx+ID2203.1x+2016T3+type@asset+block/causalbroadcast.pdf) in the respective lecture.
/// 
/// **Also mind, that to complete this part, you will first have to implement and test Best-Effort Broadcast and Reliable Broadcast, defined above.**
/// 
/// #### Working with Vector Clocks
/// 
/// We have already provided you a `VectorClock` data structure **(already imported)** to aid you with the algorithm implementation. You can briefly see the supported operations below:
/// 
/// ```
///  case class VectorClock(var vc: Map[Address, Int]) {
///   def inc(addr: Address) : Unit  //increases the clock corresponding to the address @addr provided
///   def set(addr: Address, value: Int) : Unit //sets the clock of @addr to @value
///   def <=(that: VectorClock): Boolean   //returns true if this vector clock instance is lower or equal to @that
///  }
///  object VectorClock {
///    def empty(topology: scala.Seq[Address]): VectorClock //generates a vector clock that has an initial clock value of 0 for each address in the @topology provided
///    def apply(that: VectorClock): VectorClock //copy constructor of a vector clock. E.g. if vc1 is a vector clock vc2 = VectorClock(vc1) is a copy of vc1
///  }
/// ```
/// 
/// In case you want to check the full implementation of the VectorClock, you can find it in our full published gist [here](https://gist.github.com/senorcarbone/5c960ee27a67ec8b6bd42c33303fdcd2).
class WaitingCRB(init: Init[WaitingCRB]) extends ComponentDefinition {

  //WaitingCRB Subscriptions
  val rb = requires[ReliableBroadcast];
  val crb = provides[CausalOrderReliableBroadcast];

  //WaitingCRB Component State and Initialization
  val (self, vec) = init match {
    case Init(s: Address, t: Set[Address] @unchecked) => (s, VectorClock.empty(t.toSeq))
  };

  //  val V = VectorClock.empty(init match { case Init(_, t: Set[Address]) => t.toSeq })
  var pending: ListBuffer[(Address, DataMessage)] = ListBuffer();
  var lsn = 0;

  //WaitingCRB Event Handlers
  crb uponEvent {
    case x: CRB_Broadcast => {
        /* WRITE YOUR CODE HERE */
        val W = VectorClock(vec);
        W.set(self, lsn); 
        lsn = lsn + 1;
        trigger(RB_Broadcast(DataMessage(W, x.payload)) -> rb);
    }
  }

  rb uponEvent {
    case x @ RB_Deliver(src: Address, msg: DataMessage) => {
      /* WRITE YOUR CODE HERE */
      pending += ((src, msg));
      var deliverableFound = true;
      while (deliverableFound) {
        val nextMsg = pending.find { case (p_prime, data) => data.timestamp <= vec };
        
        nextMsg match {
          case Some(entry @ (p_prime, data)) => {
            pending -= entry;
            vec.inc(p_prime);
            trigger(CRB_Deliver(p_prime, data.payload) -> crb);
          }
          case None => {
            deliverableFound = false;
          }
        }
      }
    }
  }
}

object BroadcastCheck extends App  {
    // NOTE: this exercise has 3 parts, during development feel free to comment out individual checks.
    // For submission, all checks need to pass.
    checkBEB[BasicBroadcast]();
    checkRB[BasicBroadcast,EagerReliableBroadcast]();
    checkCRB[BasicBroadcast, EagerReliableBroadcast, WaitingCRB]();
}